## 几点重要的区别

### 1. 定长和非定长的区别
长度指的是字符个数
- char 是定长的，例如 char(4)的列，插入的值是'ab', 则实际出入的是 'ab  ', 会在右侧补充 2 个空格。
- varchar 是变长的。
### 2. 存储的长度最大值不同
* char 的长度是 0 到 255 之间的任意值
* VARCHAR 列中的值是可变长度字符串。长度可以指定为 0 到 65,535 之间的值。 
### 3. 占用的字节数不同
* 变长字符集的`CHAR(M)`类型的列要求至少占用`M`个字节，比方说对于使用`utf8`字符集的`CHAR(10)`的列来说，该列存储的数据字节长度的范围是10～30个字节。即使我们向该列中存储一个空字符串也会占用`10`个字节，这是怕将来更新该列的值的字节长度大于原有值的字节长度而小于10个字节时，可以在该记录处直接更新，而不是在存储空间中重新分配一个新的记录空间，导致原有的记录空间成为所谓的碎片。
* 而`VARCHAR(M)`却没有最小占用字节的要求。VARCHAR 的有效最大长度取决于最大行大小（65,535 字节，由所有列共享）和使用的字符集。如果该`VARCHAR`类型的列没有`NOT NULL`属性，那最多只能存储`65532`个字节的数据，因为真实数据的长度可能占用2个字节，`NULL`值标识需要占用1个字节：参考 [[行格式（row format）]]
### 4. 插入的值包含空格的情况
* varchar 列中插入的空格都会保留下来。
* char 列的右侧空格，都会移除掉。


[MySQL 5.7 参考手册: 11.3.2 CHAR 和 VARCHAR 类型](https://dev.mysql.com/doc/refman/5.7/en/char.html)

## 长度的意义
CHAR 和 VARCHAR 类型的声明长度表示要存储的最大字符数。例如，CHAR(30) 最多可以包含 30 个字符。注意，是**字符**的个数。
如果创建了一个 varchar(3) 的列，插入的只是 'abcd'，这会报错的。
> Data too long for column 'ccc' at row 1

char 的长度是 0 到 255 之间的任意值

VARCHAR 列中的值是可变长度字符串。长度可以指定为 0 到 65,535 之间的值。 VARCHAR 的有效最大长度取决于最大行大小（65,535 字节，由所有列共享）和使用的字符集。


char 的长度是 0 到 255 之间的任意值
VARCHAR 最多存储 65535 个字节。
如果该`VARCHAR`类型的列没有`NOT NULL`属性，那最多只能存储`65532`个字节的数据，因为真实数据的长度可能占用2个字节，`NULL`值标识需要占用1个字节：
参考 [[行格式（row format）]]







char 是定长的，varchar 是变长的。
>长度指的是字符的个数，而非字节数。

CHAR 和 VARCHAR 类型的声明长度表示要存储的最大字符数。例如，CHAR(30) 最多可以包含 30 个字符。

CHAR 列的长度固定为您在创建表时声明的长度。长度可以是 0 到 255 之间的任意值。当存储 CHAR 值时，它们会用空格向右填充到指定的长度。检索 CHAR 值时，将删除尾随空格，除非启用 PAD_CHAR_TO_FULL_LENGTH SQL 模式。

VARCHAR 列中的值是可变长度字符串。长度可以指定为 0 到 65,535 之间的值。 VARCHAR 的有效最大长度取决于最大行大小（65,535 字节，由所有列共享）和使用的字符集。
与 CHAR 不同，VARCHAR 值存储为 1 字节或 2 字节长度前缀加上数据。长度前缀指示值中的字节数。如果值需要不超过 255 个字节，一列使用一个长度字节，如果值可能需要超过 255 个字节，则使用两个长度字节。

如果未启用严格的 SQL 模式，并且您为 CHAR 或 VARCHAR 列分配的值超过列的最大长度，则该值将被截断以适合并生成警告。对于非空格字符的截断，您可能会导致发生错误（而不是警告）并通过使用严格的 SQL 模式禁止插入值。

对于 VARCHAR 列，超出列长度的尾随空格会在插入前被截断并生成警告，而不管使用的 SQL 模式如何。对于 CHAR 列，无论 SQL 模式如何，都会以静默方式截断插入值中多余的尾随空格。

VARCHAR 值在存储时不会被填充。根据标准 SQL，在存储和检索值时保留尾随空格。

下表通过显示将各种字符串值存储到 CHAR(4) 和 VARCHAR(4) 列（假设该列使用单字节字符集，如 latin1）的结果来说明 CHAR 和 VARCHAR 之间的区别。

![[Pasted image 20221225154716.png]]
>存储在表最后一行中的值仅在不使用严格 SQL 模式时适用；如果启用了严格模式，则不会存储超过列长度的值，并会导致错误。


对于 _**CHAR(M)**_ 类型的列来说，当列采用的是定长字符集时，该列占用的字节数不会被加到变长字段长度列表，而如果采用变长字符集时，该列占用的字节数也会被加到变长字段长度列表。

变长字符集的`CHAR(M)`类型的列要求至少占用`M`个字节，而`VARCHAR(M)`却没有这个要求。比方说对于使用`utf8`字符集的`CHAR(10)`的列来说，该列存储的数据字节长度的范围是10～30个字节。即使我们向该列中存储一个空字符串也会占用`10`个字节，这是怕将来更新该列的值的字节长度大于原有值的字节长度而小于10个字节时，可以在该记录处直接更新，而不是在存储空间中重新分配一个新的记录空间，导致原有的记录空间成为所谓的碎片。

我们首先声明一下`W`、`M`和`L`的意思：

1.  假设某个字符集中表示一个字符最多需要使用的字节数为`W`，也就是使用`SHOW CHARSET`语句的结果中的`Maxlen`列，比方说`utf8`字符集中的`W`就是`3`，`gbk`字符集中的`W`就是`2`，`ascii`字符集中的`W`就是`1`。
    
2.  对于变长类型`VARCHAR(M)`来说，这种类型表示能存储最多`M`个字符（注意是字符不是字节），所以这个类型能表示的字符串最多占用的字节数就是`M×W`。
    
3.  假设它实际存储的字符串占用的字节数是`L`。
    

所以确定使用1个字节还是2个字节表示真正字符串占用的字节数的规则就是这样：

-   如果`M×W <= 255`，那么使用1个字节来表示真正字符串占用的字节数。
    
    ```!
    也就是说InnoDB在读记录的变长字段长度列表时先查看表结构，如果某个变长字段允许存储的最大字节数不大于255时，可以认为只使用1个字节来表示真正字符串占用的字节数。
    ```
    
-   如果`M×W > 255`，则分为两种情况：
    
    -   如果`L <= 127`，则用1个字节来表示真正字符串占用的字节数。
        
    -   如果`L > 127`，则用2个字节来表示真正字符串占用的字节数。
        
    
    ```!
    InnoDB在读记录的变长字段长度列表时先查看表结构，如果某个变长字段允许存储的最大字节数大于255时，该怎么区分它正在读的某个字节是一个单独的字段长度还是半个字段长度呢？设计InnoDB的大叔使用该字节的第一个二进制位作为标志位：如果该字节的第一个位为0，那该字节就是一个单独的字段长度（使用一个字节表示不大于127的二进制的第一个位都为0），如果该字节的第一个位为1，那该字节就是半个字段长度。
    
    对于一些占用字节数非常多的字段，比方说某个字段长度大于了16KB，那么如果该记录在单个页面中无法存储时，InnoDB会把一部分数据存放到所谓的溢出页中（我们后边会唠叨），在变长字段长度列表处只存储留在本页面中的长度，所以使用两个字节也可以存放下来。
    ```
    

总结一下就是说：如果该可变字段允许存储的最大字节数（`M×W`）超过255字节并且真实存储的字节数（`L`）超过127字节，则使用2个字节，否则使用1个字节。

#### VARCHAR(M)最多能存储的数据

我们知道对于`VARCHAR(M)`类型的列最多可以占用`65535`个字节。其中的`M`代表该类型最多存储的字符数量，如果我们使用`ascii`字符集的话，一个字符就代表一个字节，我们看看`VARCHAR(65535)`是否可用：

```sql
mysql> CREATE TABLE varchar_size_demo(
    ->     c VARCHAR(65535)
    -> ) CHARSET=ascii ROW_FORMAT=Compact;
ERROR 1118 (42000): Row size too large. The maximum row size for the used table type, not counting BLOBs, is 65535. This includes storage overhead, check the manual. You have to change some columns to TEXT or BLOBs
mysql>
```

从报错信息里可以看出，`MySQL`对一条记录占用的最大存储空间是有限制的，除了`BLOB`或者`TEXT`类型的列之外，其他所有的列（不包括隐藏列和记录头信息）占用的字节长度加起来不能超过`65535`个字节。所以`MySQL`服务器建议我们把存储类型改为`TEXT`或者`BLOB`的类型。这个`65535`个字节除了列本身的数据之外，还包括一些其他的数据（`storage overhead`），比如说我们为了存储一个`VARCHAR(M)`类型的列，其实需要占用3部分存储空间：

-   真实数据
-   真实数据占用字节的长度
-   `NULL`值标识，如果该列有`NOT NULL`属性则可以没有这部分存储空间

如果该`VARCHAR`类型的列没有`NOT NULL`属性，那最多只能存储`65532`个字节的数据，因为真实数据的长度可能占用2个字节，`NULL`值标识需要占用1个字节：

```sql
mysql> CREATE TABLE varchar_size_demo(
    ->      c VARCHAR(65532)
    -> ) CHARSET=ascii ROW_FORMAT=Compact;
Query OK, 0 rows affected (0.02 sec)
```

如果`VARCHAR`类型的列有`NOT NULL`属性，那最多只能存储`65533`个字节的数据，因为真实数据的长度可能占用2个字节，不需要`NULL`值标识：

```sql
mysql> DROP TABLE varchar_size_demo;
Query OK, 0 rows affected (0.01 sec)

mysql> CREATE TABLE varchar_size_demo(
    ->      c VARCHAR(65533) NOT NULL
    -> ) CHARSET=ascii ROW_FORMAT=Compact;
Query OK, 0 rows affected (0.02 sec)
```

如果`VARCHAR(M)`类型的列使用的不是`ascii`字符集，那会怎么样呢？来看一下：

```sql
mysql> DROP TABLE varchar_size_demo;
Query OK, 0 rows affected (0.00 sec)

mysql> CREATE TABLE varchar_size_demo(
    ->       c VARCHAR(65532)
    -> ) CHARSET=gbk ROW_FORMAT=Compact;
ERROR 1074 (42000): Column length too big for column 'c' (max = 32767); use BLOB or TEXT instead

mysql> CREATE TABLE varchar_size_demo(
    ->       c VARCHAR(65532)
    -> ) CHARSET=utf8 ROW_FORMAT=Compact;
ERROR 1074 (42000): Column length too big for column 'c' (max = 21845); use BLOB or TEXT instead
```

从执行结果中可以看出，如果`VARCHAR(M)`类型的列使用的不是`ascii`字符集，那`M`的最大取值取决于该字符集表示一个字符最多需要的字节数。在列的值允许为`NULL`的情况下，`gbk`字符集表示一个字符最多需要`2`个字节，那在该字符集下，`M`的最大取值就是`32766`（也就是：65532/2），也就是说最多能存储`32766`个字符；`utf8`字符集表示一个字符最多需要`3`个字节，那在该字符集下，`M`的最大取值就是`21844`，就是说最多能存储`21844`（也就是：65532/3）个字符。

```
上述所言在列的值允许为NULL的情况下，gbk字符集下M的最大取值就是32766，utf8字符集下M的最大取值就是21844，这都是在表中只有一个字段的情况下说的，一定要记住一个行中的所有列（不包括隐藏列和记录头信息）占用的字节长度加起来不能超过65535个字节！
```

